trigger:
    branches:
        include:
            - dev
            - test
            - acc
            - main

pool:
    vmImage: windows-latest
    name: 'PZH-Ubuntu-Agent'

variables:
    subscription: 'app-omgevingsbeleid-rg'

stages:
    - stage: Build
      jobs:
          - job:
            displayName: Build the application
            steps:
                - task: NodeTool@0
                  inputs:
                      versionSpec: '16.17.x'
                  displayName: 'Install Node.js'

                - task: CmdLine@2
                  displayName: 'Install dependencies'
                  inputs:
                      script: yarn install

                - task: CmdLine@2
                  displayName: 'Set env'
                  inputs:
                      script: export VITE_API_ENV=$(Build.SourceBranchName)

                - task: CmdLine@2
                  displayName: 'Build'
                  inputs:
                      script: yarn build

                - task: PublishBuildArtifacts@1
                  inputs:
                      PathtoPublish: $(System.DefaultWorkingDirectory)/build
                      ArtifactName: BuildedApp

    - stage: Dev
      dependsOn:
          - Build
      condition: eq(variables['Build.SourceBranchName'], 'dev')
      jobs:
          - deployment:
            displayName: Dev deploy
            environment: Dev
            strategy:
                runOnce:
                    deploy:
                        steps:
                            - task: AzureFileCopy@4
                              displayName: 'AzureBlob File Copy'
                              inputs:
                                  SourcePath: '$(System.DefaultWorkingDirectory)/_Provincie-Zuid-Holland.Omgevingsbeleid-Frontend'
                                  azureSubscription: $(subscription) #This is the devops service connection name
                                  Destination: AzureBlob
                                  storage: obfrontenddev
                                  ContainerName: '$web'
                                  AdditionalArgumentsForBlobCopy: '--recursive'

    # - stage: Test
    #   dependsOn:
    #       - Dev
    #   jobs:
    #       - deployment:
    #         displayName: Test deploy
    #         environment: Test
    #         strategy:
    #             runOnce:
    #                 deploy:
    #                     steps:
    #                         - task: CmdLine@2
    #                           displayName: 'Set env'
    #                           inputs:
    #                               script: export VITE_API_ENV=test

    #                         - task: CmdLine@2
    #                           displayName: 'Build'
    #                           inputs:
    #                               script: yarn build

    #                         - script: echo Running in the Test environment as deployment job
    #                           displayName: 'Test based stage'

    # - stage: Acc
    #   dependsOn:
    #       - Test
    #   jobs:
    #       - deployment:
    #         displayName: Acc deploy
    #         environment: Acc
    #         strategy:
    #             runOnce:
    #                 deploy:
    #                     steps:
    #                         - task: CmdLine@2
    #                           displayName: 'Set env'
    #                           inputs:
    #                               script: export VITE_API_ENV=acc

    #                         - task: CmdLine@2
    #                           displayName: 'Build'
    #                           inputs:
    #                               script: yarn build

    #                         - script: echo Running in the Acc environment as deployment job
    #                           displayName: 'Acc based stage'
